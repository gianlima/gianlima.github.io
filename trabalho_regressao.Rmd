---
title: "Trabalho de regressão linear"
author: "Gian Lima"
output:
  html_document:
    theme: flatly
    highlight: pygments
    toc_depth: 2
    # code_download: true
    # code_folding: show
    toc: true
    toc_float:
      collapsed: false
    # df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Importando dados

```{r}
library(magrittr)
library(corrplot)
library(readxl)
AtlasBrasil_Consulta <- read_excel("C:/Users/Eloi/Desktop/GIAN/GITHUB/gianlima.github.io/AtlasBrasil_Consulta.xlsx", skip = 1)
dados <- AtlasBrasil_Consulta
str(dados)
summary(dados)
```

# Limpeza dos dados

```{r}
# Já foram excluídas as linhas Brasil e Ceará
# Excluir variáveis código e estado
dados <- dados[,c(-1,-2)]
colnames(dados) <- paste('v',1:53, sep = "")
```

## Variável resposta

```{r}
which(dados[1,] == 26.9) # V17 # Mortalidade Infantil
```

## Retirar variáveis com *1* ou *-1* na correlação

```{r}
library(magrittr)
correlacao <- (cor(dados) %>% round(., digits = 2)) # há variáveis com NA => V12 e V15
which(is.na(dados$v12)) # linha 163
which(is.na(dados$v15)) # linhas 56 e 59
```

## Lidar com dados faltantes

Inserir a média das variáveis nos dados faltantes 

```{r}
dados[163,12] <- mean(dados$v12, na.rm = T)
dados[c(56,59),15] <- mean(dados$v15, na.rm = T)
```

## Verificar correção novamente

```{r}
correlacao <- as.data.frame(cor(dados) %>% round(., digits = 2))
table(correlacao$v17) # quatro vars com correlação -1 e duas com correlação 1 
which(correlacao$v17 == -1) # excluir variáveis v10, v19, v22 e v24

# v10: Esperança de vida ao nascer 2010
# v19: Probabilidade de sobrevivência até 40 anos 2010
# v22: IDHM Longevidade 2010
# v24: Probabilidade de sobrevivência até 60 anos 2010

which(correlacao$v17 == 1) # deu 1 na v17 porque é ela mesma, excluir apenas a var 18

# v18: Mortalidade até 5 anos de idade 2010

```

## Excluir variáveis que deram alta correlação seja negativa ou positiva com a var resposta

```{r}
ndados <- dados[,c(-10,-19,-22,-24,-18)] # novos dados ndados
dim(ndados) # agora apenas 48 variáveis
```

## Testar colinearidade

```{r}
correlacao1 <- as.data.frame(cor(ndados) %>% round(., digits = 2))
which(correlacao1$v5 == -1); which(correlacao1$v5 == 1) # correlação v5 e v11 # excluir v11
which(correlacao1$v11 == -1); which(correlacao1$v11 == 1)

which(correlacao1 == 1, arr.ind=T)
# checar variáveis v16, v30, v14, v41, v42

# não colocar + v14 e v30 juntas

which(correlacao1 == -1, arr.ind=T)


```

# Ajuste com todas as 

```{r}
ajuste <- lm(v17 ~., data = ndados)
```

```{r}
backward <- step(ajuste, direction = 'backward', test = 'F')
names(backward)
backward$terms
```


```{r}
library(readxl)
nova_plan <- read_excel("C:/Users/Eloi/Desktop/nova_plan.xlsx", skip = 1)
data <- nova_plan
colnames(data) <- paste('v',1:dim(data)[2], sep = "")
which(is.na(data), arr.ind = T)
a <- as.data.frame(cor(data) %>% round(., digits = 2))
which(a$v16 > 0.85) # apenas ela mesma

which(a == 1, arr.ind = T) # excluir 15 

```


```{r}
which(is.na(data), arr.ind = T)
data[163,11] <- mean(data$v11, na.rm = T)
data[c(56,59),14] <- mean(data$v14, na.rm = T)

data$v17
ajuste <- lm(v16 ~., data = data)
backward <- step(ajuste, direction = 'backward', test = 'F')
# 
forward1 <- step(ajuste, direction = 'forward', test = 'F')
stepwise <- step(ajuste, direction = 'both', test = 'F') 
# 23, 5, 22, 25, 30, 32, 26, 24, 24, 33,9,17
```

```{r}
ajuste <- lm(v16 ~ v32 + v26 + v24 + v33 + v9 + v17, data = data)
summary(ajuste)
data$v26
cor(data[,c('v32','v26','v24','v33','v9','v17')]) %>% round(., digits = 3)
cor(data[,c('v24','v32','v9','v17')]) %>% round(., digits = 2)
ajuste <- update(ajuste, ~.-v33) 


ajustes <- lm(v16 ~ v24 + v32 + v9 + v17, data = data)
summary(ajustes)

shapiro.test(rstudent(ajustes))

# p-valor < alpha : rejeita-se H0
0.01696 < 0.05

library(car)
ncvTest(ajuste)
0.14369< 0.05


## -----------------
ajuste <- lm(v16 ~., data = data)
stepwise <- step(ajuste, direction = 'both', test = 'F') 
ajuste1 <- lm(v16 ~ v5 + v22 + v25 + v30 + 
              v32 + v26 + v24 + v33 + v9 + v17, data = data)
summary(ajuste1) # r2_ajust. =  0.5237

mat_cor <- cor(data[,c('v5','v22','v25','v30','v32','v26','v33','v9','v17','v16')])
round(mat_cor, 2)
corrplot.mixed(mat_cor, upper = 'ellipse', number.cex = 1.2)

# Alta correlação (x >= 0.85)
# v30 e v33
# v26 e v33
# v30 e v26

# Criar novos ajustes
# tem v26 e não tem v30 nem v33 
# tem v33 e não tem v26 nem v30
# tem v30 e não tem v26 nem v33
```

# ajuste 1: tem v26 e não tem v30 nem v33

```{r}
ajuste1 <- update(ajuste, ~. -v30 - v33)
stepwise <- step(ajuste1, direction = 'both', test = 'F') 
summary(lm(v16 ~ v15 + v13 + v14 + v32 + v25 + v28 + v22 + v24 + v9 + v17, data = data))
summary(lm(v16 ~ v15 + v13 + v14 + v32 + v28 + v22 + v24 + v9 + v17, data = data))
```

# ajuste 2: tem v33 e não tem v26 nem v30

```{r}
ajuste2 <- update(ajuste, ~. -v26 - v30)
stepwise <- step(ajuste1, direction = 'both', test = 'F') 
summary(lm(v16 ~ v28 + v19 + v33 + v22 + v25 + v32 + v24 + v9 + v17, data = data))
summary(lm(v16 ~ v19 + v33 + v22 + v25 + v32 + v24 + v9 + v17, data = data))
```

# ajuste 3: tem v30 e não tem v26 nem v33

```{r}
ajuste3 <- update(ajuste, ~. -v26 -v33)
stepwise <- step(ajuste3, direction = 'both', test = 'F') 
summary(lm(v16 ~ v5 + v19 + v30 + v32 + v28 + v27 + v25 +
             v22 + v24 + v9 + v17, data = data))
summary(lm(v16 ~ v5 + v19 + v30 + v32 + v25 +
             v22 + v24 + v9 + v17, data = data))
summary(lm(v16 ~ v19 + v30 + v32 + v25 +
             v22 + v24 + v9 + v17, data = data))
```



